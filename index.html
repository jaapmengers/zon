<html>
    <head>
        <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" />
        <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
        <script src="https://unpkg.com/leaflet-shadow-simulator/dist/leaflet-shadow-simulator.umd.min.js"></script>
        <script src="https://unpkg.com/osmtogeojson/osmtogeojson.js"></script>
    </head>
    <body>
        <div id="mapid" style="width: 100%; height: 100vh;"></div>
        
        <script>

		/* Leaflet setup */
		var map = L.map("mapid", { zoomControl: false }).setView([52.46742477575272, 4.950071699076742], 20);
		L.tileLayer("https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}", {
			// attribution:
			// 	'Map data &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
			maxZoom: 21,
		}).addTo(map);

		L.control.zoom({
			position: 'bottomright'
		}).addTo(map);
		/* End Leaflet setup */


		/* ShadeMap setup */
		const loaderEl = document.getElementById('loader');
		let now = new Date(1633358583454);
		const shadeMap = L.shadeMap({
			apiKey: "eyJhbGciOiJIUzI1NiJ9.eyJlbWFpbCI6ImphYXAubWVuZ2Vyc0BnbWFpbC5jb20iLCJjcmVhdGVkIjoxNzQ2OTY2MDA5NTk2LCJpYXQiOjE3NDY5NjYwMDl9.uQqqBGSSP2FVdqcovninKoBk3sSz3zXBvXr0AsoXgtA",
			date: now,
			color: '#01112f',
			opacity: 0.9,
			terrainSource: {
				maxZoom: 15,
				tileSize: 256,
				getSourceUrl: ({ x, y, z }) => `https://s3.amazonaws.com/elevation-tiles-prod/terrarium/${z}/${x}/${y}.png`,
				getElevation: ({ r, g, b, a }) => (r * 256 + g + b / 256) - 32768,
				_overzoom: 30,
			},
			getFeatures: async () => {
				try {
					if (map.getZoom() > 15) {
						const bounds = map.getBounds();
						const north = bounds.getNorth();
						const south = bounds.getSouth();
						const east = bounds.getEast();
						const west = bounds.getWest();
						const query = `https://overpass-api.de/api/interpreter?data=%2F*%0AThis%20has%20been%20generated%20by%20the%20overpass-turbo%20wizard.%0AThe%20original%20search%20was%3A%0A%E2%80%9Cbuilding%E2%80%9D%0A*%2F%0A%5Bout%3Ajson%5D%5Btimeout%3A25%5D%3B%0A%2F%2F%20gather%20results%0A%28%0A%20%20%2F%2F%20query%20part%20for%3A%20%E2%80%9Cbuilding%E2%80%9D%0A%20%20way%5B%22building%22%5D%28${south}%2C${west}%2C${north}%2C${east}%29%3B%0A%29%3B%0A%2F%2F%20print%20results%0Aout%20body%3B%0A%3E%3B%0Aout%20skel%20qt%3B`;
                        console.log(query);
						const response = await fetch(query)
						const json = await response.json();
						const geojson = osmtogeojson(json);
						// If no building height, default to one storey of 3 meters
						geojson.features.forEach(feature => {
							// if (!feature.properties) {
							// 	feature.properties = {};
							// }
							// if (!feature.properties.height) {
								feature.properties.height = 6;
							// }
						});
						return geojson.features;
					}
				} catch (e) {
					console.error(e);
				}
				return [];
			},
			debug: (msg) => { console.log(new Date().toISOString(), msg) }
		}).addTo(map);

		// shadeMap.on('tileloaded', (loadedTiles, totalTiles) => {
		// 	loaderEl.innerText = `Loading: ${(loadedTiles / totalTiles * 100).toFixed(0)}%`;
		// });
		/* End ShadeMap setup */
	


            // var map = L.map("mapid").setView([47.69682, -121.92078], 9); 
  
            // const shadeMap = L.shadeMap({
            //   date: new Date(),    // display shadows for current date
            //   color: '#01112f',    // shade color
            //   opacity: 0.7,        // opacity of shade color
            //   apiKey: "eyJhbGciOiJIUzI1NiJ9.eyJlbWFpbCI6ImphYXAubWVuZ2Vyc0BnbWFpbC5jb20iLCJjcmVhdGVkIjoxNzQ2OTY2MDA5NTk2LCJpYXQiOjE3NDY5NjYwMDl9.uQqqBGSSP2FVdqcovninKoBk3sSz3zXBvXr0AsoXgtA",    // obtain from https://shademap.app/about/
            //   terrainSource: {
            //     tileSize: 256,       // DEM tile size
            //     maxZoom: 15,         // Maximum zoom of DEM tile set
            //     getSourceUrl: ({ x, y, z }) => {
            //       // return DEM tile url for given x,y,z coordinates
            //       return `https://s3.amazonaws.com/elevation-tiles-prod/terrarium/${z}/${x}/${y}.png`
            //     },
            //     getElevation: ({ r, g, b, a }) => {
            //       // return elevation in meters for a given DEM tile pixel
            //       return (r * 256 + g + b / 256) - 32768
            //     }
            //   },
            // }).addTo(map);
          
            // advance shade by 1 hour
          //   shadeMap.setDate(new Date(Date.now() + 1000 * 60 * 60)); 
          
            // sometime later...
            // ...remove layer
          //   shadeMap.remove();
          </script>
    </body>
</html>